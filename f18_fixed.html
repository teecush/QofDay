<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MX Daily Check-In ‚Äî Lexend</title>
<link rel="icon" href="data:,">
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a0f1e; --panel:#0f172a; --ink:#e8eef7; --muted:#94a3b8; --stroke:#1e293b;
    --brand1:#22d3ee; --brand2:#a78bfa; --ok:#34d399; --warn:#fbbf24;
    --p-blue:#e8f3ff; --p-blue-b:#93c5fd;
    --p-red:#ffe7ea; --p-red-b:#fda4af;
    --p-green:#ecfff4; --p-green-b:#86efac;
    --p-purple:#f3e8ff; --p-purple-b:#c4b5fd;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 900px at 10% 0%, #0d1634, #0a0f1e 60%);color:var(--ink);font-family:'Lexend',system-ui,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
  *{user-select:none} input,textarea,select,button{user-select:text}

  .app{display:grid;grid-template-rows:auto auto 1fr auto;gap:10px;height:100vh;padding:12px;box-sizing:border-box}

  /* Top bar: 3 columns (stats | timer | actions) */
  .topbar{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;min-height:48px}
  .stats{display:flex;gap:8px;flex-wrap:wrap}
  .stat{background:#0b1226;border:1px solid var(--stroke);border-radius:12px;padding:6px 10px;font-weight:700}

  .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end}
  .topbtn{background:#0b1226;border:1px solid var(--stroke);color:var(--ink);padding:10px 14px;border-radius:14px;font-weight:900;font-size:16px;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,.35);transition:.12s transform,.12s box-shadow;height:42px;display:inline-flex;align-items:center}
  .topbtn:active{transform:translateY(1px) scale(.98);box-shadow:0 6px 12px rgba(0,0,0,.35)}
  #randomBtn{background:radial-gradient(120% 120% at 10% 0%, var(--brand2), var(--brand1));color:#06121a;border:none}

  /* Timer (center) */
  .timerWrap{display:flex;align-items:center;justify-content:center;gap:8px}
  .timerBox{display:flex;align-items:center;gap:8px;background:#0b1226;border:1px solid var(--stroke);border-radius:12px;padding:6px 10px}
  .time{font-weight:900;font-size:20px;min-width:70px;text-align:center}
  .tbtn{background:#0c1428;border:1px solid #1f2937;color:#dbeafe;border-radius:10px;padding:6px 10px;font-weight:800;cursor:pointer}
  .tbtn:active{transform:translateY(1px)}

  /* Question */
  .questionRow{display:flex;justify-content:center;align-items:center;gap:20px;position:relative;z-index:60}
  .question{
    text-align:center;font-size:clamp(26px,5vw,58px);font-weight:900;letter-spacing:.2px;
    padding:10px 14px;background:rgba(15,23,42,.6);border:1px solid var(--stroke);border-radius:14px;
    width:min(1200px,100%);min-height:2.8em;white-space:normal;
  }
  .question-helper{
    background:rgba(15,23,42,.6);border:1px solid var(--stroke);border-radius:10px;
    min-width:100px;min-height:120px;display:flex;flex-direction:column;cursor:pointer;transition:all .2s;position:relative;
  }
  .question-helper:hover{
    background:rgba(15,23,42,.8);border-color:#475569;
  }
  .helper-title{
    padding:8px 12px;font-size:14px;font-weight:700;color:#94a3b8;text-align:center;border-bottom:1px solid var(--stroke);position:absolute;top:0;left:0;right:0;z-index:5;background:rgba(15,23,42,.9);
  }
  .helper-content{
    flex:1;padding:8px;min-height:80px;position:relative;margin-top:40px;
  }

  /* Stage */
  .stage{position:relative;display:grid;grid-template-rows:auto auto auto;gap:10px;min-height:0}
  #badgeLayer{position:absolute;inset:0;z-index:20;pointer-events:none}
  #badgeLayer .badge{pointer-events:auto}

  .zones{display:grid;gap:10px;grid-auto-rows:minmax(220px,1fr)}
  .zone{position:relative;border-radius:18px;border:2px dashed #94a3b8;padding:10px;box-shadow:0 12px 36px rgba(0,0,0,.18) inset}
  .zone h3{margin:0 0 6px 0;font-size:clamp(16px,2vw,24px);font-weight:900;color:#0b1020;text-shadow:0 1px 0 rgba(255,255,255,.7)}
  .blue{background:var(--p-blue);border-color:var(--p-blue-b)}
  .red{background:var(--p-red);border-color:var(--p-red-b)}
  .green{background:var(--p-green);border-color:var(--p-green-b)}
  .purple{background:var(--p-purple);border-color:var(--p-purple-b)}

  /* Parking */
  .parking{background:#0b1226;border-radius:16px;border:1px solid var(--stroke);padding:10px;min-height:210px;position:relative}
  #parkingPad{position:absolute;inset:8px;border:2px dashed #1f2937;border-radius:12px;min-height:230px}
  #parkingLabel{position:absolute;top:14px;left:16px;background:rgba(2,6,23,.8);border:1px solid #1f2937;color:#cbd5e1;padding:6px 10px;border-radius:10px;font-weight:900;font-size:14px;box-shadow:0 8px 18px rgba(0,0,0,.35)}

  /* Steps row */
  .stepsRow{display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 10px;height:42px;background:#0b1226;border:1px solid var(--stroke);border-radius:12px;white-space:nowrap}
  .stepPill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:900;font-size:14px;background:#0f172a;border:1px solid #1f2937}
  .stepSep{opacity:.7}

  /* Badges */
  .badge{position:absolute;touch-action:none;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;font-weight:800;font-size:clamp(14px,1.8vw,20px);color:#0b1226;background:linear-gradient(180deg,#f8fafc,#e2e8f0);box-shadow:0 10px 22px rgba(0,0,0,.35);border:2px solid #0f172a;transition:top .25s cubic-bezier(.34,1.56,.64,1), left .25s cubic-bezier(.34,1.56,.64,1);z-index:10}
  .badge.inParking:not(.teacher){background:linear-gradient(180deg,#fff1e6,#ffd7b5);border-color:#9a6a3a}
  .badge.teacher{background:linear-gradient(180deg,#fff7d6,#fde68a);border-color:#b45309}
  .badge.pickedHidden{opacity:0;pointer-events:none;transition:opacity .2s}
  .badge.spinning{outline:4px solid var(--warn)}
  .badge.winner{outline:6px solid var(--ok)}

  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
  .modal.show{display:flex}
  .sheet{width:min(1100px,95vw);max-height:90vh;overflow:auto;background:#0b1226;border:1px solid var(--stroke);border-radius:18px;padding:18px;box-shadow:0 22px 64px rgba(0,0,0,.5);color:var(--ink)}
  .sheet h2{margin:0 0 10px}
  .sheet section{border:1px solid #1f2937;border-radius:14px;padding:12px;margin:10px 0;background:#0c1428}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pair{display:flex;align-items:center;gap:8px;margin-right:16px}
  .sheet input,.sheet select,.sheet textarea,.sheet button{font-size:16px;border-radius:12px;border:1px solid #334155;background:#0b1226;color:var(--ink);padding:10px 12px}
  .sheet button{box-shadow:0 8px 18px rgba(0,0,0,.35)}
  .sheet button:active{transform:translateY(1px) scale(.98);box-shadow:0 6px 12px rgba(0,0,0,.35)}
  .answers-grid{display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .answers-grid .a{display:flex;gap:8px;align-items:center}
  .answers-grid .lbl{width:130px;font-weight:800;text-align:right;opacity:.9}
  .answers-grid input{flex:1}

  .btn-primary{background:linear-gradient(180deg,#34d399,#22c55e);color:#05220f;border:1px solid #166b3b}
  .btn-ghost{background:#0b1226;border:1px solid #1f2937;color:#d1d5db}

  .switch{position:relative;width:56px;height:30px;background:#0c1428;border:1px solid #1f2937;border-radius:999px;cursor:pointer}
  .switch input{display:none}
  .knob{position:absolute;top:3px;left:3px;width:24px;height:24px;background:#cbd5e1;border-radius:50%;transition:left .18s}
  .switch input:checked + .knob{left:29px;background:#34d399}

  .toast{position:fixed;bottom:16px;left:16px;background:#0b1226;color:var(--ink);border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;opacity:0;transform:translateY(8px);transition:.25s;z-index:120}
  .toast.show{opacity:1;transform:translateY(0)}
  #qDebug{position:fixed;right:10px;bottom:10px;background:#0b1226;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;font:12px/1.2 Lexend;color:#cbd5e1;opacity:.85;z-index:130;display:none}

  /* Response buttons */
  .response-buttons{display:flex;gap:8px}
  .response-btn{background:#0c1428;border:1px solid #1f2937;color:#dbeafe;border-radius:10px;padding:8px 16px;font-weight:800;cursor:pointer;transition:all .2s}
  .response-btn:hover{background:#0f172a;border-color:#334155}
  .response-btn.active{background:linear-gradient(180deg,#34d399,#22c55e);color:#05220f;border-color:#166b3b}

  /* Preset buttons */
  .preset-btn{background:#0f172a;border:1px solid #334155;color:#94a3b8;border-radius:10px;padding:8px 16px;font-weight:800;cursor:pointer;transition:all .2s}
  .preset-btn:hover{background:#1e293b;border-color:#475569;color:#cbd5e1}
</style>
</head>
<body>

<div class="app" id="app">
  <div class="topbar">
    <div class="stats">
      <span class="stat" id="statPlaced">Placed: 0</span>
      <span class="stat" id="statAbsent">Absent (not placed): 0</span>
    </div>

    <!-- Center timer -->
    <div class="timerWrap">
      <div class="timerBox">
        <button class="tbtn" id="tReset">‚Üª</button>
        <button class="tbtn" id="minus30">‚àí</button>
        <div class="time" id="timeText">1:00</div>
        <button class="tbtn" id="plus30">+</button>
        <button class="tbtn" id="startPause">‚ñ∂</button>
      </div>
    </div>

    <div class="actions">
      <button class="topbtn" id="openSettings">‚öôÔ∏è Settings</button>
      <button class="topbtn" id="quickReset">Reset</button>
      <button class="topbtn" id="readAloudBtn">üó£Ô∏è</button>
      <button class="topbtn" id="randomBtn">üé° Pick Random Student</button>
    </div>
  </div>

  <div class="questionRow">
    <div class="question-helper" id="partnerArea">
      <div class="helper-title">üîé Partner</div>
      <div class="helper-content"></div>
    </div>
    <div class="question" id="question">Loading question‚Ä¶</div>
    <div class="question-helper" id="helpArea">
      <div class="helper-title">üìñ Help</div>
      <div class="helper-content"></div>
    </div>
  </div>
  <!-- Hidden live region for enforced paint/AT -->
  <div aria-live="polite" aria-atomic="true" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden" id="qLive">Loading question‚Ä¶</div>

  <div class="stage" id="stage">
    <div class="zones" id="zones"></div>
    <div class="parking" id="parking"><div id="parkingPad"></div><div id="parkingLabel">üÖøÔ∏è Parking Lot / Absent</div></div>
    <div class="stepsRow">
      <div class="stepPill">üìñ READ</div><span class="stepSep">‚Ä∫</span>
      <div class="stepPill">ü§î THINK</div><span class="stepSep">‚Ä∫</span>
      <div class="stepPill">üë• DISCUSS</div><span class="stepSep">‚Ä∫</span>
      <div class="stepPill">‚û°Ô∏è MOVE</div><span class="stepSep">‚Ä∫</span>
      <div class="stepPill">üó£Ô∏è EXPLAIN</div>
    </div>
    <div id="badgeLayer"></div>
  </div>
</div>

<!-- Settings modal -->
<div class="modal" id="settingsModal"><div class="sheet">
  <h2>‚öôÔ∏è Settings</h2>

  <!-- 1. Question -->
  <section>
    <div class="row">
      <label style="min-width:110px;font-weight:800">Question</label>
      <input id="qInput" placeholder="Daily question (or generate with AI)" style="flex:1"/>
    </div>
  </section>

  <!-- 2. Responses -->
  <section>
    <div class="row" style="gap:16px">
      <div class="pair">
        <label style="min-width:110px;font-weight:800">Responses</label>
        <div class="response-buttons">
          <button class="response-btn" data-value="2">2</button>
          <button class="response-btn" data-value="3">3</button>
          <button class="response-btn active" data-value="4">4</button>
          <button class="response-btn" data-value="open">Open</button>
          <button class="response-btn" data-value="wyr">Would You Rather?</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 3. Response fields -->
  <section id="answersWrap">
    <div class="answers-grid">
      <div class="a"><div class="lbl">Answer A</div><input id="a1" value="Work alone"></div>
      <div class="a"><div class="lbl">Answer B</div><input id="a2" value="Work with a partner"></div>
      <div class="a"><div class="lbl">Answer C</div><input id="a3" value="Ask a teacher"></div>
      <div class="a"><div class="lbl">Answer D</div><input id="a4" value="Try a new strategy"></div>
    </div>
  </section>

  <!-- Filters + AI -->
  <section>
    <div class="row" style="margin-top:4px">
      <label style="font-weight:800">Keywords</label>
      <input id="keywordInput" placeholder="e.g., patterns, habitats, friendship" style="flex:1;min-width:260px"/>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="pair">
        <label style="font-weight:800">Grade</label>
        <select id="gradeInput"><option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
      </div>
      <div class="pair">
        <label style="font-weight:800">Concise</label>
        <label class="switch" title="Shorten questions and responses">
          <input type="checkbox" id="conciseToggle">
          <span class="knob"></span>
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="pair"><label style="font-weight:800">Bloom's</label>
        <select id="bloomsInput">
          <option>Remember</option><option>Understand</option><option>Apply</option><option>Analyze</option>
          <option selected>Evaluate</option><option>Create</option>
        </select>
      </div>
      <div class="pair"><label style="font-weight:800">Subject</label>
        <select id="subjectInput">
          <option selected>General</option><option>Math</option><option>Language</option><option>Science</option>
          <option>Social Studies</option><option>Drama</option><option>Dance</option>
          <option>Visual Arts</option><option>Music</option><option>Phys-Ed</option>
        </select>
      </div>
      <div class="pair"><label style="font-weight:800">Learning Skill</label>
        <select id="lsInput">
          <option selected>General</option>
          <option>Responsibility</option><option>Organization</option><option>Independent Work</option>
          <option>Collaboration</option><option>Initiative</option><option>Self-Regulation</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:16px">
      <button id="genBtn">‚ú® Generate with AI</button>
      <button id="aiBtn">ü§ñ AI Settings</button>
      <span id="aiStatusMain" style="font-weight:700;color:#94a3b8">AI: not checked</span>
    </div>

  </section>

  <!-- Tools row -->
  <section>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <button id="openRoster">üë• Edit Roster</button>
      <button id="saveBtn">üíæ Save Layout</button>
      <button id="loadBtn">‚≠≥ Load Layout</button>
      <button id="allToParkingBtn">üÖøÔ∏è All to Parking</button>
      <button id="resetWeekBtn">üóìÔ∏è Reset Week</button>
    </div>
  </section>

  <!-- Preset buttons row -->
  <section>
    <div class="row" style="gap:12px;flex-wrap:wrap">
      <button id="presetMood" class="preset-btn">üü¶üü•üü®üü© Mood Checker</button>
      <button id="presetWeekend" class="preset-btn">üå§Ô∏è Weekend Reflection</button>
      <button id="presetLeo" class="preset-btn">ü¶Å Leo's Ceremony</button>
    </div>
  </section>

  <div class="row" style="justify-content:center;margin-top:16px;gap:20px">
    <button id="applySettings" class="btn-primary" style="font-weight:900;padding:14px 24px;font-size:18px">‚úÖ OK</button>
    <button id="closeSettings" class="btn-ghost" style="padding:14px 24px;font-size:18px">Cancel</button>
  </div>
</div></div>

<!-- Roster modal -->
<div class="modal" id="rosterModal"><div class="sheet">
  <h2>üë• Edit roster (students only)</h2>
  <textarea id="rosterInput" style="width:100%;min-height:260px">Abdallah
Robyn
Layla
Keerthy
Hakim
Melania
Halo
Abbas
Penelope
Harnoor
Sean
Su
Caleb
Elena
Selena
Anisha
Iris
Jazmine
Alayna
Shreyansh</textarea>
  <div class="row"><button id="applyRoster">Apply roster</button><button id="closeRoster">Cancel</button></div>
</div></div>

<!-- AI settings -->
<div class="modal" id="aiModal"><div class="sheet">
  <h2>ü§ñ AI Question Generator (Gemini)</h2>
  <p>A default API key is provided, but you can paste your own Google AI Studio key (saved locally in your browser).</p>
  <div class="row"><label style="min-width:140px">API Key</label><input id="aiKey" placeholder="AIza..." style="flex:1"/></div>
      <div class="row"><label style="min-width:140px">Model</label><input id="aiModel" placeholder="gemini-2.0-flash" style="flex:1"/></div>
  <div class="row"><span id="aiStatusDetail2" style="flex:1;font-weight:700;color:#94a3b8">Status: not checked</span><button id="aiTest">Test Connection</button></div>
  <div style="height:10px"></div>
  <button id="aiSave" class="btn-primary">Save</button> <button id="aiClose" class="btn-ghost">Cancel</button>
</div></div>

<!-- Winner -->
<div class="modal" id="winnerModal"><div class="sheet" style="text-align:center">
  <h2 id="winnerText" style="font-size:clamp(28px,4.8vw,60px);margin:0 0 8px"></h2>
  <div id="winnerSub" style="font-size:clamp(18px,2.4vw,30px);opacity:.9"></div>
  <button id="closeWinner" class="btn-primary">OK</button>
</div></div>

<div class="toast" id="toast"></div>
<div id="qDebug" style="display:none"></div>

<script>
(function(){
  const SHOW_Q_DEBUG = false;

  // ---------- helpers ----------
  const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
  const raf=()=>new Promise(r=>requestAnimationFrame(()=>r()));
  const rect=el=>el.getBoundingClientRect();
  const center=el=>{const r=rect(el);return{x:r.left+r.width/2,y:r.top+r.height/2}};
  const within=(p,el)=>{const r=rect(el);return p.x>=r.left&&p.x<=r.right&&p.y>=r.top&&p.y<=r.bottom};
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f}catch{return f}};
  function toast(m){const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700)}

  // ---------- QUESTION: hard replace + live region + repaint ----------
  function updateQDebug(){
    if(!SHOW_Q_DEBUG) return;
    const box = document.getElementById('qDebug');
    const last = localStorage.getItem('mxq_last_question_raw') || '(none)';
    const meta = localStorage.getItem('mxq_ai_lastgen') || '(no meta)';
    box.style.display='block';
    box.textContent = `Q(raw): ${last}  |  meta: ${meta}`;
  }
  async function renderQuestionForce(text){
    console.log('renderQuestionForce called with:', text);
    const row = document.querySelector('.questionRow');
    const old = document.getElementById('question');
    console.log('Found question row:', row);
    console.log('Found old question element:', old);
    
    const n = document.createElement('div');
    n.className = old.className; n.id = 'question';
    n.textContent = text || '‚Äî';
    console.log('Created new question element with text:', n.textContent);
    
    // replace node
    row.replaceChild(n, old);
    console.log('Replaced question element');
    
    // live region update for AT + paint
    const live = document.getElementById('qLive');
    live.textContent = text || '‚Äî';
    console.log('Updated live region with text:', live.textContent);
    
    // Repaint nudges
    await raf(); await raf();
    n.style.transform='translateZ(0)'; // promote
    void n.offsetHeight;
    // tiny swap to force glyph rasterization
    n.textContent = (text||'‚Äî') + '\u00A0';
    await raf();
    n.textContent = (text||'‚Äî');
    console.log('Final question element text:', n.textContent);
    
    // Force a complete refresh of the question field
    setTimeout(() => {
      const finalQuestion = document.getElementById('question');
      console.log('Question element after timeout:', finalQuestion);
      console.log('Question element text content after timeout:', finalQuestion?.textContent);
      
      // If the question still doesn't match, force update it
      if (finalQuestion && finalQuestion.textContent !== text) {
        console.log('Question content mismatch detected, forcing update...');
        finalQuestion.textContent = text;
        console.log('Forced question update to:', finalQuestion.textContent);
      }
    }, 50);
  }
  function setQuestionSafe(q){
    console.log('setQuestionSafe called with:', q);
    let text = (q||'').trim();
    console.log('Trimmed text:', text);
    localStorage.setItem('mxq_last_question_raw', text);
    
    if(!text || text.replace(/\s+/g,'').length<2){
      console.log('Question too short, using fallback');
      const grade=load('mxq_grade','2'), subject=load('mxq_subject','General'), blooms=load('mxq_blooms','Evaluate');
      const verbMap={Remember:'show what you know',Understand:'explain your thinking',Apply:'use your skills',Analyze:'compare or find a pattern',Evaluate:'choose and justify',Create:'plan or design'};
      const verb=verbMap[blooms]||'explain your thinking';
      text = subject!=='General'?`How will you ${verb} in ${subject} today?`:`What is one smart way you can ${verb} today?`;
      localStorage.setItem('mxq_ai_lastgen', JSON.stringify({questionSource:'fallback',time:Date.now()}));
    } else {
      console.log('Using AI-generated question');
      const prev = JSON.parse(localStorage.getItem('mxq_ai_lastgen')||'{}');
      localStorage.setItem('mxq_ai_lastgen', JSON.stringify({...prev,questionSource:'model',time:Date.now()}));
    }
    
    console.log('About to render question:', text);
    renderQuestionForce(text).then(() => {
      console.log('Question rendering complete');
      updateQDebug();
      
      // Check if the question is actually in the DOM
      const questionElement = document.getElementById('question');
      console.log('Question element after render:', questionElement);
      console.log('Question element text content:', questionElement?.textContent);
      
      // Also update the qInput field in settings if it exists
      const qInput = document.getElementById('qInput');
      if (qInput) {
        qInput.value = text;
        console.log('Updated qInput field with:', text);
      }
    });
  }
  // If anything empties the question, restore it
  const mo=new MutationObserver(()=>{
    const q=document.getElementById('question');
    if(q && (!q.textContent || q.textContent.trim()==='')){
      console.log('Mutation observer detected empty question, restoring...');
      const last=localStorage.getItem('mxq_last_question_raw')||'‚Äî';
      console.log('Restoring question to:', last);
      renderQuestionForce(last);
    }
  });
  mo.observe(document.body,{subtree:true,childList:true,characterData:true});

  // ---------- zones / choices ----------
  function setCols(n){$('#zones').style.gridTemplateColumns=`repeat(${n},minmax(0,1fr))`}
  function buildZones(choices,colors){
    const wrap=$('#zones'); wrap.innerHTML=''; setCols(choices.length);
    choices.forEach((c,i)=>{const z=document.createElement('div'); z.className='zone '+(colors?.[i]||['blue','red','green','purple'][i%4]); z.dataset.zone=i; const h=document.createElement('h3'); h.textContent=c; z.appendChild(h); wrap.appendChild(z);});
  }
  function ensureEmojis(choices){
    // add emoji if none detected on any; keep if already present
    const hasAny = choices.some(c=>/^\p{Emoji}/u.test(c));
    if(hasAny) return choices;
    const pool=["ü§ù","üé≤","üìñ","üîÑ","üé®","‚òÄÔ∏è","üë´","üèÉ","üéµ","üé≠","üçé","üåé","üß©","‚úèÔ∏è","üñåÔ∏è","‚öΩ","üé∂","ü¶ã","üöÄ","ü™¥","üïäÔ∏è","üîç","üß†","üí°","üõ†Ô∏è","üó∫Ô∏è","üß™","üìê","üßÆ","üó£Ô∏è"];
    const used=new Set();
    return choices.map(c=>{let e=pool.find(x=>!used.has(x))||"üéØ"; used.add(e); return `${e} ${c}`});
  }
  function applyChoices(mode,lines){
    let choices=[];
    if(mode==='open'){choices=['üó£Ô∏è I've got my answer and I'm ready to explain why.']}
    else{
      const n=Math.max(2,Math.min(4,parseInt(mode,10)||4));
      choices=lines.slice(0,n).filter(Boolean);
      if(n>=3){
        const haveOther=choices.some(c=>/other/i.test(c));
        const final = haveOther? choices.filter(c=>!/other/i.test(c)).concat('Other (explain)') : choices.slice(0,n-1).concat('Other (explain)');
        choices=final;
      }
    }
    if(mode==='wyr'){
      choices=lines.slice(0,2).filter(Boolean);
    }
    choices = ensureEmojis(choices); // <- keep emojis at start
    const colors=choices.map((_,i)=>['blue','red','green','purple'][i%4]);
    buildZones(choices,colors);
    // Don't overwrite the question when saving choices
    const currentQ = $('#question').textContent || localStorage.getItem('mxq_last_question_raw') || '';
    save('mxq_choices',{q:currentQ,choices,colors,mode});
    stats();
  }

  // ---------- parking + badges + auto-bump ----------
  const TEACHER='Mr. Cushman';
  let roster=[], badges=[], drag=null, pickedSet=new Set();
  function parkingGrid(){const pad=$('#parkingPad'), rs=$('#stage').getBoundingClientRect(); const r=pad.getBoundingClientRect(); const topPad=42; const left0=r.left-rs.left+20, top0=r.top-rs.top+topPad, usableW=r.width-40; return {left0, top0, cols:Math.max(4,Math.floor(usableW/140))};}
  function distribute(resetAll=false){
    const g=parkingGrid(); let i=0;
    badges.filter(b=>b.dataset.ignore!=='true').forEach(b=>{
      if(!resetAll && b.dataset.zone!=='parking') return;
      const col=i%g.cols, row=Math.floor(i/g.cols);
      b.style.left=(g.left0+col*140)+'px'; b.style.top=(g.top0+row*64)+'px';
      b.dataset.zone='parking'; b.dataset.lastX=b.style.left; b.dataset.lastY=b.style.top;
      b.classList.add('inParking'); i++;
    });
    i++;
    const t=badges.find(b=>b.dataset.ignore==='true');
    if(t){
      const col=i%g.cols,row=Math.floor(i/g.cols);
      t.style.left=(g.left0+col*140)+'px'; t.style.top=(g.top0+row*64)+'px';
      t.dataset.zone='parking'; t.dataset.lastX=t.style.left; t.dataset.lastY=t.style.top;
      t.classList.add('inParking');
    }
  }
  function makeBadges(){
    $('#badgeLayer').innerHTML=''; badges=[];
    const g=parkingGrid(); let i=0;
    roster.forEach(name=>{
      const el=document.createElement('div'); el.className='badge inParking'; el.textContent=name; el.setAttribute('draggable','false'); el.ondragstart=()=>false;
      const col=i%g.cols,row=Math.floor(i/g.cols);
      el.style.left=(g.left0+col*140)+'px'; el.style.top=(g.top0+row*64)+'px';
      el.dataset.zone='parking'; el.dataset.lastX=el.style.left; el.dataset.lastY=el.style.top;
      $('#badgeLayer').appendChild(el); enableDrag(el); badges.push(el); i++;
    });
    i++;
    const t=document.createElement('div'); t.className='badge teacher inParking'; t.textContent=TEACHER; t.setAttribute('draggable','false'); t.ondragstart=()=>false;
    const col=i%g.cols,row=Math.floor(i/g.cols);
    t.style.left=(g.left0+col*140)+'px'; t.style.top=(g.top0+row*64)+'px';
    t.dataset.zone='parking'; t.dataset.ignore='true'; t.dataset.lastX=t.style.left; t.dataset.lastY=t.style.top;
    $('#badgeLayer').appendChild(t); enableDrag(t); badges.push(t);
    stats();
  }
  function enableDrag(el){
    el.addEventListener('pointerdown',e=>{e.preventDefault();el.setPointerCapture(e.pointerId);const r=el.getBoundingClientRect();drag={el,dx:e.clientX-r.left,dy:e.clientY-r.top};el.style.zIndex=Date.now();});
    el.addEventListener('pointermove',e=>{if(!drag||drag.el!==el)return;const s=$('#stage').getBoundingClientRect();el.style.left=(e.clientX-s.left-drag.dx)+'px';el.style.top=(e.clientY-s.top-drag.dy)+'px';});
    el.addEventListener('pointerup',()=>{if(!drag||drag.el!==el)return;settle(el);drag=null;});
  }
  function zoneSlots(zoneEl){
    // returns an array of absolute positions inside zone where a badge could snap, avoiding the title
    const sR=$('#stage').getBoundingClientRect();
    const zR=zoneEl.getBoundingClientRect();
    const h=zoneEl.querySelector('h3');
    const headBottom = h? h.getBoundingClientRect().bottom : zR.top+10;
    const startY = headBottom + 8 - sR.top;
    const left = zR.left - sR.left + 10;
    const right = zR.right - sR.left - 10;
    const width = right - left;
    const cols = Math.max(1, Math.floor(width/140));
    const rows = 6; // plenty
    const out=[];
    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        out.push({x:left + c*140, y:startY + r*64});
      }
    }
    return out;
  }
  function overlaps(a,b){
    const ax=parseFloat(a.style.left), ay=parseFloat(a.style.top);
    const bx=parseFloat(b.style.left), by=parseFloat(b.style.top);
    return Math.abs(ax-bx)<130 && Math.abs(ay-by)<56; // rough badge footprint
  }
  function placeInZone(el, zoneEl){
    const slots=zoneSlots(zoneEl);
    
    // For response containers, find a slot that doesn't overlap with existing badges
    if (zoneEl.classList.contains('zone')) {
      for (const slot of slots) {
        let canPlace = true;
        // Check if this slot overlaps with any existing badge in this zone
        const existingBadges = badges.filter(b => b.dataset.zone === zoneEl.dataset.zone);
        for (const badge of existingBadges) {
          if (overlaps({style: {left: slot.x + 'px', top: slot.y + 'px'}}, badge)) {
            canPlace = false;
            break;
          }
        }
        if (canPlace) {
          el.style.left = slot.x + 'px';
          el.style.top = slot.y + 'px';
          el.dataset.zone = zoneEl.dataset.zone;
          el.dataset.lastX = el.style.left;
          el.dataset.lastY = el.style.top;
          el.classList.remove('inParking');
          el.style.zIndex = Date.now();
          return true;
        }
      }
      return false;
    }
    
    // For other areas, use first slot
    const firstSlot = slots[0];
    if(firstSlot) {
      el.style.left=firstSlot.x+'px'; el.style.top=firstSlot.y+'px';
      el.dataset.zone=zoneEl.dataset.zone; el.dataset.lastX=el.style.left; el.dataset.lastY=el.style.top;
      el.classList.remove('inParking');
      el.style.zIndex = Date.now();
      return true;
    }
    
    return false;
  }
  function settle(el){
    const pt=center(el), targets=[...document.querySelectorAll('.zone'),$('#parkingPad'),$('#partnerArea'),$('#helpArea')];
    let landed=false;
    for(const t of targets){
      if(within(pt,t)){
        if(t.id==='parkingPad'){
          el.dataset.zone='parking';
          el.dataset.lastX=el.style.left; el.dataset.lastY=el.style.top;
          el.classList.add('inParking');
          landed=true; break;
        }else if(t.id==='partnerArea'){
          // Allow free placement anywhere in the helper area, but not overlapping the title
          const areaRect = t.getBoundingClientRect();
          const stageRect = $('#stage').getBoundingClientRect();
          const titleHeight = 40; // Height of the title area
          
          // Calculate position relative to the stage
          const relativeX = pt.x - stageRect.left;
          const relativeY = pt.y - stageRect.top;
          
          // Ensure badge doesn't overlap the title area
          const finalY = Math.max(relativeY, areaRect.top - stageRect.top + titleHeight + 10);
          
          el.style.left = relativeX + 'px';
          el.style.top = finalY + 'px';
          el.dataset.zone='partner';
          el.dataset.lastX=el.style.left; el.dataset.lastY=el.style.top;
          el.classList.remove('inParking');
          el.style.zIndex = Date.now();
          landed=true; break;
        }else if(t.id==='helpArea'){
          // Allow free placement anywhere in the helper area, but not overlapping the title
          const areaRect = t.getBoundingClientRect();
          const stageRect = $('#stage').getBoundingClientRect();
          const titleHeight = 40; // Height of the title area
          
          // Calculate position relative to the stage
          const relativeX = pt.x - stageRect.left;
          const relativeY = pt.y - stageRect.top;
          
          // Ensure badge doesn't overlap the title area
          const finalY = Math.max(relativeY, areaRect.top - stageRect.top + titleHeight + 10);
          
          el.style.left = relativeX + 'px';
          el.style.top = finalY + 'px';
          el.dataset.zone='help';
          el.dataset.lastX=el.style.left; el.dataset.lastY=el.style.top;
          el.classList.remove('inParking');
          el.style.zIndex = Date.now();
          landed=true; break;
        }else{
          // auto-bump away from title area + snap to free slot
          if(!placeInZone(el, t)){
            // if no slot found, snap back
            el.style.left=el.dataset.lastX||el.style.left;
            el.style.top =el.dataset.lastY||el.style.top;
          } else {
            // Ensure the badge is brought to front when placed
            el.style.zIndex = Date.now();
          }
          landed=true; break;
        }
      }
    }
    if(!landed){
      // if dropped nowhere, snap back
      el.style.left=el.dataset.lastX||el.style.left; el.style.top=el.dataset.lastY||el.style.top;
    }
    stats();
  }
  function stats(){
    const isStu=b=>b.dataset.ignore!=='true';
    const placed=badges.filter(b=>isStu(b)&&b.dataset.zone!=='parking'&&b.dataset.zone!=='partner'&&b.dataset.zone!=='help'&&!b.classList.contains('pickedHidden'));
    const total=badges.filter(isStu).length;
    const hidden=badges.filter(b=>isStu(b)&&b.classList.contains('pickedHidden')).length;
    const partner=badges.filter(b=>isStu(b)&&b.dataset.zone==='partner').length;
    const help=badges.filter(b=>isStu(b)&&b.dataset.zone==='help').length;
    const absent=total-placed.length-hidden-partner-help;
    $('#statPlaced').textContent='Placed: '+placed.length;
    $('#statAbsent').textContent='Absent (not placed): '+absent;
  }

  // ---------- random picker ----------
  function weekKey(d=new Date()){const date=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const day=date.getUTCDay()||7;date.setUTCDate(date.getUTCDate()+4-day);const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1));const weekNo=Math.ceil((((date-yearStart)/86400000)+1)/7);return date.getUTCFullYear()+'-W'+String(weekNo).padStart(2,'0')}
  function ensureWeek(){const cur=weekKey();const s=load('mxq_week'); if(s!==cur){save('mxq_week',cur);save('mxq_picked',[]); pickedSet.clear()} else {pickedSet=new Set(load('mxq_picked',[]))}}
  function persistPicked(){save('mxq_picked',Array.from(pickedSet))}
  function randomPick(){
    const base=badges.filter(b=>b.dataset.zone!=='parking'&&b.dataset.ignore!=='true'&&!b.classList.contains('pickedHidden'));
    let pool=base.filter(b=>!pickedSet.has(b.textContent.trim()));
    if(pool.length===0){pickedSet.clear();persistPicked();pool=base.slice(); if(pool.length===0){toast('No placed names.'); return;} toast('New round this week!')}
    pool.forEach(b=>b.classList.remove('spinning','winner'));
    const rounds=Math.floor(Math.max(24,6+pool.length*2)*1.5), baseDelay=40; let i=0;
    function tick(){try{const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.type='square';o.frequency.value=800+Math.random()*200;g.gain.setValueAtTime(0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.08);o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.09);setTimeout(()=>c.close(),120)}catch{}}
    function win(){try{const c=new (window.AudioContext||window.webkitAudioContext)();const o=c.createOscillator(),g=c.createGain();o.type='triangle';o.frequency.value=620;g.gain.setValueAtTime(0.001,c.currentTime);g.gain.exponentialRampToValueAtTime(0.12,c.currentTime+0.02);g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+0.5);o.connect(g).connect(c.destination);o.start();o.stop(c.currentTime+0.55);setTimeout(()=>c.close(),600)}catch{}}
    function step(){
      pool.forEach(b=>b.classList.remove('spinning'));
      const idx=i%pool.length; pool[idx].classList.add('spinning'); tick(); i++;
      const p=i/rounds, d=baseDelay+p*p*260;
      if(i<rounds) setTimeout(step,d); else{
        pool.forEach(b=>b.classList.remove('spinning','winner'));
        const w=pool[(i-1)%pool.length]; w.classList.add('winner'); win();
        const z=w.dataset.zone; let ans=''; const zEl=document.querySelector(`.zone[data-zone="${z}"] h3`); if(zEl) ans=zEl.textContent.trim();
        const name=w.textContent.trim(); pickedSet.add(name); persistPicked(); setTimeout(()=>{w.classList.add('pickedHidden'); stats()},120);
        $('#winnerText').textContent=name; $('#winnerSub').textContent=`please explain your answer: ${ans||'your choice'}`; $('#winnerModal').classList.add('show');
      }
    }
    step();
  }
  $('#randomBtn').onclick=randomPick; $('#closeWinner').onclick=()=>$('#winnerModal').classList.remove('show');

  // ---------- AI (Gemini) ----------
  const GEMINI_MODEL_DEFAULT='gemini-2.0-flash';
  const getKey = () => {
    const key = (load('mxq_ai_key')||'AIzaSyDpx9ITK7RRlxYgbVaF_gkDJAAdmkjBzoQ').trim();
    return key;
  };
  
  // Backup API keys in case the main one gets rate limited
  const BACKUP_KEYS = [
    'AIzaSyDpx9ITK7RRlxYgbVaF_gkDJAAdmkjBzoQ',
    // Add more backup keys here if needed
  ];
  const getModel = () => {
    // Force use of the working model for now
    return 'gemini-2.0-flash';
  };
  const bloomsVerb=lv=>({remember:'show what you know',understand:'explain your thinking',apply:'use your skills',analyze:'compare or find a pattern',evaluate:'choose and justify',create:'plan or design'})[(lv||'apply').toLowerCase()]||'explain your thinking';

  function buildPrompt({count,kw,grade,subject,ls,blooms,concise,mode}){
    const isWyr = mode === 'wyr';
    const prompt = `
You are generating a Grade ${grade} DAILY CHECK-IN for Ontario classrooms, aligned with the Ontario Curriculum and Ontario Learning Skills.

SUBJECT: ${subject}
LEARNING SKILL: ${ls}
BLOOM'S LEVEL: ${blooms}
KEYWORDS/TOPIC HINTS: ${kw || 'none'}
STYLE: ${concise?'CONCISE (question ‚â§ ~7 words; choices 1-4 words, Grade 1 reading level)':'Normal length (kid-friendly)'}
${isWyr ? 'FORMAT: Would You Rather (2 choices)' : ''}

Return ONLY a single JSON object with BOTH fields present (no extra text, no code fences, no markdown):
{"question":"<short, general, applicable-anytime prompt inviting a brief explanation>",
 "choices":["<broad option>","<broad option>", "..."]}

Constraints:
- "question" must be ONE sentence, kid-friendly, and HYPOTHETICAL (use "could", "would", "might", "if" - not past tense like "did" or "was").${concise?'\n- Keep question under ~7 words; each choice 1-4 words. Use simple words a Grade 1 student can read easily.':''}
- Questions should ask "How could you..." or "What would you..." not "How did you..." or "What was..."
- Make questions engaging and thought-provoking like these examples:
  * "Would you rather..." (comparison choices)
  * "If you could..." (imaginative scenarios)
  * "What would you do if..." (hypothetical situations)
  * "How could you show..." (character/behavior focused)
  * "What makes a good..." (reflection on qualities)
${isWyr ? '- For "Would You Rather" format: Start question with "Would you rather..." and provide exactly 2 contrasting choices' : ''}
- Questions should encourage personal reflection, creativity, and critical thinking
- Provide EXACTLY ${count} choices. If ${count} is 3 or 4, the LAST choice MUST be "üìù Other (explain)".
- Choices should be broad strategies/frames that encourage critical thinking (not hyper-specific facts).
- DO NOT include backticks, markdown, explanations, or any fields other than "question" and "choices".
`.trim();
    
    console.log('Built prompt:', prompt);
    return prompt;
  }
  function parseJSONLenient(txt){
    if(!txt) return null;
    let cleaned = txt.replace(/```[\s\S]*?```/g, m => m.replace(/```(?:json)?/gi,'').replace(/```/g,'')).replace(/```(?:json)?/gi,'').replace(/```/g,'').trim();
    try { return JSON.parse(cleaned); } catch {}
    const m = cleaned.match(/\{[\s\S]*\}/);
    if(m){ try { return JSON.parse(m[0]); } catch {} }
    return null;
  }
  function addEmojisUnique(arr){
    const pool=["ü§ù","üé≤","üìñ","üîÑ","üé®","‚òÄÔ∏è","üë´","üèÉ","üéµ","üé≠","üçé","üåé","üß©","‚úèÔ∏è","üñåÔ∏è","‚öΩ","üé∂","ü¶ã","üöÄ","ü™¥","üïäÔ∏è","üîç","üß†","üí°","üõ†Ô∏è","üó∫Ô∏è","üß™","üìê","üßÆ","üó£Ô∏è","üìù"];
    const hints=[[/(read|story|book|text)/i,"üìñ"],[/(friend|kind|include|help)/i,"ü§ù"],[/(music|song|rhythm)/i,"üéµ"],[/(art|draw|paint|colour|color)/i,"üé®"],[/(move|exercise|run|sport)/i,"üèÉ"],[/(pattern|sequence)/i,"üîÑ"],[/(science|experiment|observe)/i,"üß™"],[/(map|timeline|community)/i,"üó∫Ô∏è"],[/(math|count|shape|measure)/i,"üßÆ"]];
    const used=new Set();
    return arr.map((c)=>{
      if(/other/i.test(c)) return "üìù "+c.replace(/^üìù\s*/i,'');
      let emo=""; for(const [re,e] of hints){ if(re.test(c)&&!used.has(e)){ emo=e; break; } }
      if(!emo){ emo = pool.find(e=>!used.has(e)&&e!=="üìù") || "üéØ"; }
      used.add(emo); return `${emo} ${String(c).replace(/^[^\w\d]+/,'').trim()}`;
    });
  }
  function postConcise(obj, concise){
    if(!concise) return obj;
    const shortQ = obj.question.replace(/\s+/g,' ').split(' ').slice(0,7).join(' ');
    const shortC = obj.choices.map(c=>c.replace(/\s+/g,' ').split(' ').slice(0,4).join(' '));
    return {question:shortQ.trim(), choices:shortC};
  }
  async function geminiQ(count,kw,grade,subject,ls,blooms,concise){
    const key=getKey(); if(!key) throw new Error('No Gemini key.');
    
    console.log('geminiQ called with:', {count, kw, grade, subject, ls, blooms, concise});
    console.log('Using key length:', key.length);
    
    // Use only the working model
    const modelsToTry = ['gemini-2.0-flash'];
    let obj0 = null; // Declare obj0 outside the loop
    let currentModel = 'gemini-2.0-flash'; // Track the current model
    
    for(const tryModel of modelsToTry) {
      currentModel = tryModel; // Update the current model
      try {
        console.log('Trying model:', tryModel);
        const url=`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(tryModel)}:generateContent?key=${encodeURIComponent(key)}`;
        const prompt=buildPrompt({count,kw,grade,subject,ls,blooms,concise,mode:modeSel});
        
        console.log('Making request to:', url);
        const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:prompt}]}]})});
        console.log('Response status:', res.status);
        
        if(!res.ok) {
          const errorText = await res.text();
          console.log('Error response:', errorText);
          if(res.status === 429) {
            console.log(`Rate limit hit for model ${tryModel}, trying next model...`);
            continue; // Try next model
          } else if(res.status === 403) {
            throw new Error('API key invalid or quota exceeded. Please check your API key.');
          } else {
            throw new Error(`Gemini ${res.status}: ${errorText}`);
          }
        }
        const data=await res.json();
        console.log('Response data:', data);
        const txt=(data?.candidates?.[0]?.content?.parts||[]).map(p=>p.text||'').join(' ').trim();
        console.log('Extracted text:', txt);
        localStorage.setItem('mxq_ai_raw', txt);
        obj0=parseJSONLenient(txt); // Assign to the outer variable
        console.log('Parsed object:', obj0);
        if(!obj0 || !Array.isArray(obj0.choices)) throw new Error('Bad AI JSON - missing or invalid choices array');
        
        // If we get here, the request was successful
        console.log('Success with model:', tryModel);
        break;
      } catch(e) {
        console.log('Error with model', tryModel, ':', e.message);
        if(tryModel === modelsToTry[modelsToTry.length - 1]) {
          // This was the last model to try
          throw e;
        }
        // Try next model
        continue;
      }
    }

    // normalize choices + emojis + policy for Other
    const want=count;
    const nonOther=obj0.choices.filter(Boolean).filter(c=>!(/other/i.test(c)));
    if(want>=3){
      while(nonOther.length<want-1) nonOther.push('Share another idea');
      obj0.choices=addEmojisUnique(nonOther.slice(0,want-1).concat('Other (explain)'));
    } else {
      while(nonOther.length<2) nonOther.push('Share another idea');
      obj0.choices=addEmojisUnique(nonOther.slice(0,2));
    }

    const obj = postConcise(obj0, concise);

    if(typeof obj.question!=='string' || !obj.question.trim()){
      const verb=({Remember:'show what you know',Understand:'explain your thinking',Apply:'use your skills',Analyze:'compare or find a pattern',Evaluate:'choose and justify',Create:'plan or design'}[blooms]||'explain your thinking');
      obj.question = (kw?`How will you ${verb} about ${kw} today?`:(subject!=='General'?`How will you ${verb} in ${subject} today?`:`What is one smart way you can ${verb} today?`));
      localStorage.setItem('mxq_ai_lastgen', JSON.stringify({used:'gemini',questionSource:'fallback',time:Date.now(),model:currentModel}));
    } else {
      localStorage.setItem('mxq_ai_lastgen', JSON.stringify({used:'gemini',questionSource:'model',time:Date.now(),model:currentModel}));
    }
    return obj;
  }
  function offlineQ(count,subject,ls,concise){
    const qs={
      General:['What is one way you can help our class learn well today? Explain your choice.','How can you show your thinking clearly? Explain your choice.'],
      Responsibility:['How can you show responsibility during our work time? Explain.'],
      Organization:['What can you do to stay organized for this task? Explain your choice.'],
      'Independent Work':['What helps you stay focused when working on your own? Explain.'],
      Collaboration:['What makes group work go well? Explain your choice.'],
      Initiative:['What is a way you can take initiative in your learning today? Explain.'],
      'Self-Regulation':['What will you do if you feel stuck or upset during learning? Explain.']
    };
    let q=(qs[ls]||qs.General)[Math.floor(Math.random()*2)];
    const base={General:['Use a model','Ask a question','Explain with an example','Other (explain)'],
      Math:['Estimate first','Look for a pattern','Draw a model','Other (explain)'],
      Language:['Use a detail from the text','Use your own example','Ask a question','Other (explain)'],
      Science:['Observe','Make a prediction','Test an idea','Other (explain)'],
      'Social Studies':['Consider different viewpoints','Use a map or timeline','Connect to our community','Other (explain)']};
    const list=(base[subject]||base.General).slice(0,count>=4?4:count);
    let choices; if(count>=3){choices=list.slice(0,count-1).concat('Other (explain)')} else {choices=list.slice(0,2)}
    choices=addEmojisUnique(choices);
    if(concise){ q=q.split(' ').slice(0,12).join(' '); choices=choices.map(c=>c.split(' ').slice(0,5).join(' ')); }
    localStorage.setItem('mxq_ai_lastgen', JSON.stringify({used:'offline',questionSource:'offline',time:Date.now()}));
    return {question:q,choices};
  }
  async function getQ(count,kw,grade,subject,ls,blooms,concise){
    try{
      const key = getKey();
      if(!key) {
        throw new Error('No key');
      }
      return await geminiQ(count,kw,grade,subject,ls,blooms,concise);
    }catch(e){
      console.log('AI generation failed, falling back to offline:', e.message);
      return offlineQ(count,subject,ls,concise);
    }
  }

  // ---------- settings ----------
  function toggleAnswerFields(mode){
    const grid=document.querySelector('.answers-grid'); grid.style.display=(mode==='open')?'none':'grid';
    const show=n=>$('#a'+n).parentElement.style.display='flex', hide=n=>$('#a'+n).parentElement.style.display='none';
    show(1);show(2);show(3);show(4);
    if(mode==='2'){hide(3);hide(4)} 
    if(mode==='3'){show(3);hide(4)} 
    if(mode==='4'){show(3);show(4)}
    if(mode==='wyr'){
      hide(3);hide(4);
      // Set default "Would you rather" options
      $('#a1').value = 'Option A';
      $('#a2').value = 'Option B';
    }
  }
  function getSelectedResponseMode() {
    const activeBtn = document.querySelector('.response-btn.active');
    return activeBtn ? activeBtn.dataset.value : '4';
  }
  
  function setSelectedResponseMode(mode) {
    document.querySelectorAll('.response-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.value === mode);
    });
  }
  
  function openSettings(){
    const s=load('mxq_choices'); $('#qInput').value=s?.q||$('#question').textContent||'';
    const mode=s?.mode||'4'; setSelectedResponseMode(mode);
    const cur=s?.choices || Array.from(document.querySelectorAll('.zone h3')).map(h=>h.textContent);
    ['a1','a2','a3','a4'].forEach((id,i)=> $('#'+id).value=(cur[i]||'').replace(/^(\p{Emoji_Presentation}|\p{Emoji})\s*/u,'')); // allow editing text without emoji
    $('#gradeInput').value=load('mxq_grade','2'); $('#subjectInput').value=load('mxq_subject','General'); $('#lsInput').value=load('mxq_ls','General'); $('#keywordInput').value=load('mxq_keywords',''); $('#bloomsInput').value=load('mxq_blooms','Evaluate');
    $('#conciseToggle').checked = !!load('mxq_concise', false);
    toggleAnswerFields(mode); $('#settingsModal').classList.add('show'); aiStatus();
  }
  // Response button handlers
  document.querySelectorAll('.response-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      // Remove active class from all buttons
      document.querySelectorAll('.response-btn').forEach(b => b.classList.remove('active'));
      // Add active class to clicked button
      e.target.classList.add('active');
      // Toggle answer fields based on selected value
      toggleAnswerFields(e.target.dataset.value);
    });
  });
  document.addEventListener('keydown',e=>{ if(e.key==='Enter'&&$('#settingsModal').classList.contains('show')){ if(e.target && e.target.tagName==='TEXTAREA') return; e.preventDefault(); $('#genBtn').click(); }});
  $('#openSettings').onclick=openSettings;
  $('#closeSettings').onclick=()=>$('#settingsModal').classList.remove('show');
  $('#applySettings').onclick=()=>{
    const mode=getSelectedResponseMode();
    const q=$('#qInput').value.trim()||'Which choice fits you best right now? Explain why.';
    setQuestionSafe(q);
    const lines=(mode==='open')?[]:[$('#a1').value,$('#a2').value,$('#a3').value,$('#a4').value].map(s=>s.trim()).filter(Boolean);
    applyChoices(mode,lines);
    const saved=load('mxq_choices')||{}; save('mxq_choices',{...saved,q:$('#question').textContent});
    save('mxq_grade',$('#gradeInput').value); save('mxq_subject',$('#subjectInput').value); save('mxq_ls',$('#lsInput').value);
    save('mxq_keywords',$('#keywordInput').value); save('mxq_blooms',$('#bloomsInput').value);
    save('mxq_concise',$('#conciseToggle').checked);
    $('#settingsModal').classList.remove('show');
  };

  function aiStatus(){
    const s=load('mxq_ai_status');
    const main=$('#aiStatusMain'), det=$('#aiStatusDetail'), det2=$('#aiStatusDetail2');
    let mainMsg='AI: not checked', detailMsg='Status: not checked';
    if(s){const t=new Date(s.time).toLocaleTimeString(); mainMsg = s.ok?`Connected ‚úÖ (gemini) [${t}]`:`Not connected ‚ùå (gemini) [${t}]`; detailMsg = mainMsg.replace('AI: ','Status: ');}
    main.textContent=mainMsg; if(det) det.textContent=detailMsg; if(det2) det2.textContent=detailMsg;
  }
  $('#aiBtn').onclick=()=>{ 
    const savedKey = load('mxq_ai_key');
    $('#aiKey').value = savedKey || 'AIzaSyDpx9ITK7RRlxYgbVaF_gkDJAAdmkjBzoQ'; 
    $('#aiModel').value=load('mxq_ai_model')||'gemini-2.0-flash'; 
    $('#aiModal').classList.add('show'); 
    aiStatus(); 
  };
  $('#aiSave').onclick=()=>{ save('mxq_ai_key',$('#aiKey').value.trim()); save('mxq_ai_model',$('#aiModel').value.trim()); $('#aiModal').classList.remove('show'); toast('AI settings saved'); aiStatus(); };
  $('#aiClose').onclick=()=>$('#aiModal').classList.remove('show');
  $('#aiTest').onclick=async()=>{ 
    console.log('=== AI CONNECTION TEST START ===');
    console.log('Current timestamp:', Date.now());
    console.log('Forcing fresh test...');
    console.log('Using FIXED version of the file');
    
    // Clear any cached model settings
    localStorage.removeItem('mxq_ai_model');
    localStorage.removeItem('mxq_ai_status');
    console.log('Cleared all cached AI settings');
    
    const ok = await (async()=>{
      try{
        // Check if we can even get the key
        const key = getKey();
        console.log('API Key retrieved, length:', key.length);
        console.log('API Key starts with:', key.substring(0, 10) + '...');
        
        if(!key || key.length < 10) {
          console.log('ERROR: Invalid API key');
          return false;
        }
        
        // Try the simplest possible test with the working model
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${encodeURIComponent(key)}`;
        console.log('Making request to:', url.substring(0, 100) + '...');
        
        const res = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            contents:[{
              role:'user',
              parts:[{text:'Say "hello"'}]
            }]
          })
        });
        
        console.log('Response status:', res.status);
        console.log('Response ok:', res.ok);
        
        if(!res.ok) {
          const errorText = await res.text();
          console.log('ERROR: Response not ok:', res.status, errorText);
          return false;
        }
        
        const data = await res.json();
        console.log('SUCCESS: Got response:', data);
        return true;
        
      }catch(e){
        console.log('ERROR: Exception caught:', e.message);
        console.log('ERROR: Full error:', e);
        return false;
      }
    })(); 
    console.log('=== AI CONNECTION TEST END ===');
    console.log('Final result:', ok);
    save('mxq_ai_status',{ok,provider:'gemini',time:Date.now()}); 
    aiStatus(); 
    toast(ok?'AI connected':'AI not connected'); 
  };

  $('#genBtn').onclick=async()=>{
    console.log('=== GENERATE BUTTON CLICKED ===');
    const modeSel=getSelectedResponseMode();
    const count = modeSel==='open' ? 1 : modeSel==='wyr' ? 2 : parseInt(modeSel,10);
    const kw=$('#keywordInput').value.trim(), grade=$('#gradeInput').value, subject=$('#subjectInput').value, ls=$('#lsInput').value, blooms=$('#bloomsInput').value;
    const concise=!!$('#conciseToggle').checked; save('mxq_concise', concise);
    
    console.log('Generation params:', {modeSel, count, kw, grade, subject, ls, blooms, concise});
    
    try{
      console.log('Attempting AI generation...');
      const out=await getQ(count===1?4:count,kw,grade,subject,ls,blooms,concise);
      console.log('AI generation result:', out);
      
      console.log('Setting question:', out.question);
      await setQuestionSafe(out.question);                  // paint first and wait
      
      console.log('Applying choices:', out.choices);
      applyChoices(count===1?'open':String(count), out.choices); // keep emojis!
      
      console.log('Updating answer fields...');
      ['a1','a2','a3','a4'].forEach((id,i)=> $('#'+id).value=(out.choices?.[i]||'').replace(/^(\p{Emoji_Presentation}|\p{Emoji})\s*/u,'').trim());
      
      aiStatus(); toast('AI generated');
      console.log('=== GENERATION COMPLETE ===');
    }catch(e){
      console.log('AI generation failed, using offline:', e);
      const out=offlineQ(count===1?4:count,subject,ls,concise);
      await setQuestionSafe(out.question);
      applyChoices(count===1?'open':String(count), out.choices);
      await setQuestionSafe(out.question);
      aiStatus(); toast('AI (offline)');
    }
  };

  // roster/save/load/reset buttons
  $('#openRoster').onclick=()=>$('#rosterModal').classList.add('show');
  $('#closeRoster').onclick=()=>$('#rosterModal').classList.remove('show');
  $('#applyRoster').onclick=()=>{ roster=$('#rosterInput').value.split(/\n+/).map(s=>s.trim()).filter(Boolean); save('mxq_roster',roster); makeBadges(); awaitLayoutSpread(); $('#rosterModal').classList.remove('show'); toast('Roster applied') };
  $('#saveBtn').onclick=()=>{const layout=badges.map(b=>({name:b.textContent.trim(),left:b.style.left,top:b.style.top,zone:b.dataset.zone,hidden:b.classList.contains('pickedHidden'),ig:b.dataset.ignore==='true'})); save('mxq_layout',layout); toast('Layout saved')};
  $('#loadBtn').onclick=()=>{const layout=load('mxq_layout'); if(!layout){toast('No saved layout');return} const map=new Map(layout.map(x=>[x.name,x])); badges.forEach(b=>{const r=map.get(b.textContent.trim()); if(r){b.style.left=r.left;b.style.top=r.top;b.dataset.zone=r.zone;b.dataset.lastX=r.left;b.dataset.lastY=r.top;b.classList.toggle('pickedHidden',!!r.hidden); if(b.dataset.zone==='parking') b.classList.add('inParking'); else b.classList.remove('inParking');}}); stats(); toast('Layout loaded')};
  $('#allToParkingBtn').onclick=()=>{distribute(true); toast('All to Parking')};
  $('#resetWeekBtn').onclick=()=>{pickedSet.clear();save('mxq_picked',[]);badges.forEach(b=>b.classList.remove('pickedHidden')); stats(); toast('Weekly picks cleared')};
  $('#quickReset').onclick=()=>{
    distribute(true); 
    resetT(); // Also reset timer
    toast('All to Parking & Timer Reset')};

  // presets
  $('#presetMood').onclick=()=>{
    const choices=['üòå Blue Zone','üò† Red Zone','üòë Yellow Zone','üôÇ Green Zone'];
    setQuestionSafe('What Zone are you in?');
    buildZones(choices,['blue','red','yellow','green']);
    save('mxq_choices',{q:$('#question').textContent,choices,colors:['blue','red','yellow','green'],mode:'4'});
    $('#settingsModal').classList.remove('show');
    stats();
  };
  $('#presetWeekend').onclick=()=>{
    setQuestionSafe('What was the most interesting part of your weekend?');
    const lines=[
      'Something new I did or learned',
      'Doing one of my favourite things',
      'Spending time with someone I love',
      'Something else'
    ];
    applyChoices('4',lines);
    $('#settingsModal').classList.remove('show');
  };
  $('#presetLeo').onclick=()=>{
    setQuestionSafe('ü¶Å What was your favourite part of the week? ‚ù§Ô∏è');
    const lines=[
      'Something new I did or learned',
      'Doing one of my favourite things',
      'Spending time with someone I love',
      'Something else'
    ];
    applyChoices('4',lines);
    $('#settingsModal').classList.remove('show');
  };

  async function awaitLayoutSpread(){ await raf(); await raf(); distribute(true); stats(); }
  async function boot(){
    if (localStorage.getItem('mxq_grade') === null)   save('mxq_grade','2');
    if (localStorage.getItem('mxq_blooms') === null)  save('mxq_blooms','Evaluate');
    if (localStorage.getItem('mxq_subject') === null) save('mxq_subject','General');
    if (localStorage.getItem('mxq_ls') === null)      save('mxq_ls','General');
    if (localStorage.getItem('mxq_concise') === null) save('mxq_concise', false);

    ensureWeek();
    roster = load('mxq_roster') || $('#rosterInput').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);

    const grade=load('mxq_grade','2'), subject=load('mxq_subject','General'), ls=load('mxq_ls','General'), blooms=load('mxq_blooms','Evaluate'), kw=load('mxq_keywords',''); const concise=!!load('mxq_concise',false);
    let out;
    try{ out = await getQ(4,kw,grade,subject,ls,blooms,concise);} catch{ out = offlineQ(4,subject,ls,concise);}
    setQuestionSafe(out.question);
    // ensure emojis on initial choices too
    const initChoices = ensureEmojis(out.choices||[]);
    buildZones(initChoices, initChoices.map((_,i)=>['blue','red','green','purple'][i%4]));
    save('mxq_choices',{q:$('#question').textContent,choices:initChoices,mode:'4'});

    makeBadges();
    await awaitLayoutSpread();

    let t; const ro=new ResizeObserver(()=>{clearTimeout(t); t=setTimeout(()=>{distribute(false)},60)}); ro.observe($('#parkingPad'));
    window.addEventListener('resize',()=>{clearTimeout(t); t=setTimeout(()=>{distribute(false)},120)});

    aiStatus(); updateQDebug();
  }
  boot();

  // ---------- TIMER ----------
  let tSeconds=60, tTicker=null, tRunning=false;
  const txt=()=>{const m=Math.floor(tSeconds/60), s=String(tSeconds%60).padStart(2,'0'); return `${m}:${s}`}
  function renderTime(){ $('#timeText').textContent=txt() }
  function chime(){ try{const c=new (window.AudioContext||window.webkitAudioContext)(); const o=c.createOscillator(), g=c.createGain(); o.type='sine'; o.frequency.value=880; g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(0.18,c.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,c.currentTime+1.0); o.connect(g).connect(c.destination); o.start(); o.stop(c.currentTime+1.05); setTimeout(()=>c.close(),1200);}catch{} }
  function tick(){
    if(!tRunning) return;
    if(tSeconds>0){ tSeconds--; renderTime(); if(tSeconds===0){ chime(); $('#startPause').textContent='‚ñ∂'; tRunning=false; clearInterval(tTicker); tTicker=null; } }
  }
  function start(){ if(tRunning) return; tRunning=true; $('#startPause').textContent='‚è∏'; if(!tTicker) tTicker=setInterval(tick,1000) }
  function pause(){ tRunning=false; $('#startPause').textContent='‚ñ∂'; if(tTicker){clearInterval(tTicker); tTicker=null} }
  function toggleRun(){ tRunning?pause():start() }
  function add(sec){ tSeconds=Math.max(0,Math.min(60*60, tSeconds+sec)); renderTime(); }
  function resetT(){ 
    pause(); 
    tSeconds=60; 
    renderTime(); 
    // Also reset weekly picks when timer is reset
    pickedSet.clear();
    save('mxq_picked',[]);
    badges.forEach(b=>b.classList.remove('pickedHidden'));
    stats();
  }

  function readAloud(){
    // Ensure voices are loaded
    if (window.speechSynthesis.getVoices().length === 0) {
      window.speechSynthesis.onvoiceschanged = () => {
        readAloud();
      };
      return;
    }
    
    const question = $('#question').textContent;
    const choices = Array.from(document.querySelectorAll('.zone h3')).map(h => h.textContent);
    
    // Remove emojis from text for speech - improved regex
    const cleanQuestion = question.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F018}-\u{1F270}]|[\u{238C}-\u{2454}]|[\u{20D0}-\u{20FF}]/gu, '');
    const cleanChoices = choices.map(choice => choice.replace(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]|[\u{1F900}-\u{1F9FF}]|[\u{1F018}-\u{1F270}]|[\u{238C}-\u{2454}]|[\u{20D0}-\u{20FF}]/gu, ''));
    
    // Create speech synthesis
    const speech = new SpeechSynthesisUtterance();
    speech.text = `${cleanQuestion}. The choices are: ${cleanChoices.join('. ')}`;
    speech.rate = 0.9;
    speech.pitch = 1.1;
    speech.volume = 0.9;
    
    // Try to get a Canadian or natural voice
    const voices = window.speechSynthesis.getVoices();
    const preferredVoices = voices.filter(voice => 
      voice.name.includes('Samantha') || 
      voice.name.includes('Alex') || 
      voice.name.includes('Victoria') ||
      voice.name.includes('Daniel') ||
      voice.name.includes('Karen') ||
      voice.name.includes('Tessa') ||
      voice.name.includes('Tom') ||
      voice.name.includes('Fiona') ||
      voice.name.includes('Moira') ||
      voice.name.includes('Rishi') ||
      voice.name.includes('Ava') ||
      voice.name.includes('Siri') ||
      voice.name.includes('Google') ||
      voice.name.includes('Microsoft')
    );
    
    if (preferredVoices.length > 0) {
      speech.voice = preferredVoices[0];
    }
    
    // Highlight individual words as they're spoken
    let wordIndex = 0;
    const words = speech.text.split(' ');
    
    speech.onboundary = (event) => {
      if (event.name === 'word') {
        // Remove previous highlighting
        document.querySelectorAll('.highlight-word').forEach(el => {
          el.classList.remove('highlight-word');
        });
        
        // Highlight current word
        const currentWord = words[wordIndex];
        if (currentWord) {
          // Find and highlight the word in the question
          const questionEl = $('#question');
          const questionText = questionEl.textContent;
          const wordStart = questionText.indexOf(currentWord);
          if (wordStart !== -1) {
            // Create a temporary highlight effect for the specific word
            const beforeWord = questionText.substring(0, wordStart);
            const afterWord = questionText.substring(wordStart + currentWord.length);
            
            questionEl.innerHTML = `${beforeWord}<span class="highlight-word" style="background-color: rgba(34, 211, 153, 0.5); border-radius: 4px; padding: 2px 4px;">${currentWord}</span>${afterWord}`;
            
            setTimeout(() => {
              questionEl.innerHTML = questionText;
            }, 300);
          }
        }
        wordIndex++;
      }
    };
    
    speech.onend = () => {
      // Remove any remaining highlighting
      document.querySelectorAll('.highlight-word').forEach(el => {
        el.classList.remove('highlight-word');
      });
      $('#question').innerHTML = $('#question').textContent;
    };
    
    // Start speaking
    window.speechSynthesis.speak(speech);
  }

  $('#minus30').onclick=()=>add(-30);
  $('#plus30').onclick=()=>add(+30);
  $('#startPause').onclick=toggleRun;
  $('#tReset').onclick=resetT;
  $('#readAloudBtn').onclick=readAloud;
  renderTime();

})();
</script>
</body>
</html>